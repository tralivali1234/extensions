<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<ChartScript GroupBy="Optional">
  <Columns>
    <Column DisplayName="Bubble" ColumnType="Groupable" IsGroupKey="true" />
    <Column DisplayName="Size" ColumnType="Magnitude" />
    <Column DisplayName="Parent" ColumnType="Groupable" IsGroupKey="true" IsOptional="true" />
    <Column DisplayName="ColorScale" ColumnType="Magnitude" IsOptional="true" />
    <Column DisplayName="ColorScheme" ColumnType="Groupable" IsGroupKey="true" IsOptional="true" />
  </Columns>
  <Parameters>
    <Parameter Name="Scale" Type="Enum" ValueDefinition="ZeroMax | MinMax | Log" />
    <Parameter Name="StrokeColor" Type="String" ValueDefinition="" />
    <Parameter Name="StrokeWidth" Type="Number" ValueDefinition="2" />
    <Parameter Name="FillOpacity" Type="Number" ValueDefinition="0.8" />
    <Parameter Name="ColorScale" Type="Enum" ValueDefinition="ZeroMax | MinMax | Sqrt  | Log" />
    <Parameter Name="ColorInterpolate" Type="Enum" ValueDefinition="YlGn|YlGnBu|GnBu|BuGn|PuBuGn|PuBu|BuPu|RdPu|PuRd|OrRd|YlOrRd|YlOrBr|Purples|Blues|Greens|Oranges|Reds|Greys|PuOr|BrBG|PRGn|PiYG|RdBu|RdGy|RdYlBu|Spectral|RdYlGn" />
    <Parameter Name="ColorScheme" Type="Enum" ValueDefinition="category10|accent|dark2|paired|pastel1|pastel2|set1|set2|set3|BrBG[K]|PRGn[K]|PiYG[K]|PuOr[K]|RdBu[K]|RdGy[K]|RdYlBu[K]|RdYlGn[K]|Spectral[K]|Blues[K]|Greys[K]|Oranges[K]|Purples[K]|Reds[K]|BuGn[K]|BuPu[K]|OrRd[K]|PuBuGn[K]|PuBu[K]|PuRd[K]|RdPu[K]|YlGnBu[K]|YlGn[K]|YlOrBr[K]|YlOrRd[K]" />
    <Parameter Name="ColorSchemeSteps" Type="Enum" ValueDefinition="3|4|5|6|7|8|9|10|11" />
    <Parameter Name="NumberOpacity" Type="Number" ValueDefinition="0.8" />
    <Parameter Name="NumberSizeLimit" Type="Number" ValueDefinition="18" />
    <Parameter Name="NumberColor" Type="String" ValueDefinition="white" />
  </Parameters>
  <Icon FileName="bubblepack.png"><![CDATA[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]]></Icon>
  <Script><![CDATA[function DrawChart(chart, data){

  if(width == 0 || height == 0)
    return;
  
  var color = null;
  if(data.columns.c3.token != null)
  {
    var scaleFunc = scaleFor(data.columns.c3, data.rows.map(function(r){return r.c3;}), 0, 1, data.parameters["ColorScale"]);
    var colorInterpolator = ChartUtils.getColorInterpolation(data.parameters["ColorInterpolate"]);
    color = function(v){return colorInterpolator(scaleFunc(v.c3)); }
  }
  else if(data.columns.c4.token != null) 
  {
    var scheme = ChartUtils.getColorScheme(data.parameters["ColorScheme"], data.parameters["ColorSchemeSteps"]);
    var categoryColor = d3.scaleOrdinal(scheme).domain(data.rows.map(function(v) { return v.c4; }));
    color = function(v) { return v.c4.color || categoryColor(v.c4); };
  }
  else
  { 
    var scheme = ChartUtils.getColorScheme(data.parameters["ColorScheme"], data.parameters["ColorSchemeSteps"]);
    var categoryColor =  d3.scaleOrdinal(scheme).domain(data.rows.map(function(v) { return v.c0; }));
    color = function(v) { return v.c0.color || categoryColor(v.c0); };
  }
  
  var folderColor = null;
  if(!data.columns.c2.token != null){
    var scheme = ChartUtils.getColorScheme(data.parameters["ColorScheme"], data.parameters["ColorSchemeSteps"]);
    var categoryColor =  d3.scaleOrdinal(scheme).domain(data.rows.map(function(v) { return v.c2; }));
    folderColor = function(c2) { return  c2.color || categoryColor(c2); };
  }
  
  var format = d3.format(",d");
  
  var root = ChartUtils.stratifyTokens(data, "c0", "c2");
  
  root.sum(function(d) { return d.value; })
  .sort(function(a, b) { return b.value - a.value; })
  
  var size = scaleFor(data.columns.c1, data.rows.map(function(r){return r.c1;}), 0, 1, data.parameters["Scale"]);
  
  root.sum(function(r){
      return r == null ? 0: size(r.c1);
  });

  var bubble = d3.pack()
     .size([width, height])
     .padding(2);
 
  bubble(root);
  
  var nodes = root.descendants().filter(function(d){return d.data.isRoot == null;});
    
  var node = chart.selectAll("g.node")
      .data(nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
	  .attr('data-click', function(p) { return getClickKeys(p, data.columns); });
  
  node.append("circle")
      .attr('shape-rendering', 'initial')
      .attr("r", function(d) { return d.r; })
      .style("fill", function(d) { return d.data.folder ? folderColor(d.data.folder): color(d.data); })
      .style("fill-opacity", function(d) { return data.parameters["FillOpacity"]; })
      .style("stroke", function(d) { return data.parameters["StrokeColor"] || (d.data.folder ? folderColor(d.data.folder): color(d.data)); })
      .style("stroke-width", data.parameters["StrokeWidth"])
      .style("stroke-opacity", 1)
      .attr('data-click', function(p) { return p.data.folder ? getClickKeys({ c2 : p.data.folder }, data.columns): getClickKeys(p.data, data.columns); });

  var showNumber = data.parameters["NumberOpacity"] > 0;
  var numberSizeLimit = data.parameters["NumberSizeLimit"];
  
  node.filter(function(d){return !d.data.folder;}).append("text")
      .attr('dominant-baseline', 'central')
      .attr('text-anchor', 'middle')
  	  .attr("dy",function(d) { return  showNumber &&  d.r > numberSizeLimit ? "-0.5em" : null;})
      .text(function(d) { return d.data.folder ? d.data.folder.niceToString(): d.data.c0 ? (d.data.c0.niceToString()) : undefined; })
      .attr('data-click', function(p) { return p.data.folder ? getClickKeys({ c2 : p.data.folder }, data.columns) : getClickKeys(p.data, data.columns); })
      .each(function(d) { return ellipsis(this, d.r * 2, 1, ""); });
  
  if(showNumber)
  {
    node.filter(function(d) { return d.r > numberSizeLimit; })
    	.append("text")
        .attr('fill',  data.parameters["NumberColor"] )
        .attr('dominant-baseline', 'central')
        .attr('text-anchor', 'middle')
        .attr('font-weight', 'bold')
    	.attr('opacity', function(d) { return data.parameters["NumberOpacity"] * d.r / 30; })
        .attr("dy", ".5em")
        .attr('data-click', function(p) { return p.data.folder ? getClickKeys({ c2 : p.data.folder }, data.columns) : getClickKeys(p.data, data.columns); })
        .text(function(d) { return d.data.c1; });
  }
  
  node.append('svg:title')
  	  .text(function(d) { 
    		var key = (d.data.folder ? d.data.folder.niceToString() : 
    			(d.data.c0.niceToString() + (data.columns.c2.token == null ? '' : (' (' + (d.data.c2 ? d.data.c2.niceToString() : null) + ')'))));
     
    
    		var value = (d.data.folder ? format(size.invert(d.value)) : 
                         (d.data.c1 + (data.columns.c3.token == null ? '' : (' (' + d.data.c3 + ')'))));
    
    		return key + ': '  + value;
        });
}]]></Script>
</ChartScript>